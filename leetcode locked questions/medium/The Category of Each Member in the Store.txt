WITH CTE AS (
    SELECT MEMBER_ID, COUNT(B.VISIT_ID)*100/COUNT(A.VISIT_ID) AS SCORE FROM VISITS A
    LEFT JOIN PURCHASES B 
    ON A.VISIT_ID=B.VISIT_ID
    GROUP BY MEMBER_ID
)

SELECT A.*, 
case when SCORE>=80 then "Diamond"
when SCORE>=50 and SCORE<80 then "Gold"
when SCORE <50 then "Silver"
WHEN SCORE IS NULL THEN "Bronze" end as category
FROM MEMBERS A
LEFT JOIN CTE B
ON A.MEMBER_ID=B.MEMBER_ID
ORDER BY 1